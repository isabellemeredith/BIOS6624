---
title: "Data Analysis Plan Project 1"
author: |
  |
  |
  | Analysts: Isabelle Meredith
  | Investigators: Nichole Carlson
  | Report generated: `r format(Sys.Date(), '%m/%d/%Y')`
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_document:
    highlight: espresso
    number_sections: yes
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float: yes
  header-includes:
    \usepackage{float}
    \floatplacement{figure}{H}
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'h')
```

# Introduction

The data for this project come from the prospective cohort study, Multicenter AIDS Cohort Study, which investigates the natural and treated courses of HIV-1 in gay and bisexual men in four major US cities. This study focuses on the subset of the data where participants were prescribed highly active antiretroviral treatment (HAART), the standard treatment for HIV-1. Measures of physical and mental health were taken at baseline before treatment and annually each year after for eight years. The goal of this secondary analysis is to examine whether there is a difference in treatment efficacy at two years after treatment initiation between subjects who were using hard drugs at baseline and subjects who were not. The outcomes of interest in this analysis are viral load, CD4+ T cell count, an aggregate physical quality of life score, and an aggregate mental quality of life score. 

The purpose of this report is to develop the analysis plan to investigate the following hypothesis:

1.Hypothesis: Treatment response to HAART as measured by viral load, CD4+ T cell count, an aggregate physical quality of life score, and an aggregate mental quality of life score is lower in subjects who were hard drug users at baseline than in subjects who were not.

# Methods

## Data Cleaning

The dataset was filtered to include only subjects that had values at baseline and year 2. 209 subjects did not have values at year 2. This yielded 506 subjects. 18 subjects who were either missing BMI values or had BMI values that were negative or greater than 100 were removed from analysis, leaving 488 subjects. Additionally, 7 subjects were missing either the baseline or year 2 aggregate scores for physical and mental, and will be removed from those analyses, yielding 481 subjects for those models. 14 subjects were missing either the baseline or year 2 viral loads and CD4+ T cell counts, and will be removed from those analyses, yielding 474 subjects for those models. Viral load was log transformed as viral loads can vary from tenths of a copy per mL to millions of copies per mL. In order to have categories with sufficient counts to be meaningful, education level was collapsed into "less than a high school diploma", "high school diploma or some college", "college degree or some graduate school", or "graduate degree". Additionally, due to low number of subjects in the category "black, hispanic," the category was collapsed into "other".

## Data Analysis

A univariable analysis between each of the four outcomes at year two and hard drug use at baseline will be performed using general linear regression in both a frequentist and a Bayesian framework. The frequentist and Bayesian analyses will be conducted separately. Assumptions of linearity, homoscedasticity, and normality will be confirmed using diagnostic plots. A complete case analysis will be used for each model. P values <0.05 will be considered significant. The baseline value for the outcome of each model will included in the model as adjustment. Age, BMI, smoking, race, adherence to treatment, and education will be included as covariates due to their relevance in outcomes in previous studies. The Bayesian models will use non-informative normal priors for each of the beta coefficients and a half Cauchy for the residual standard error.

# Preliminary Results

```{r tableone, echo=FALSE, message=FALSE, fig.pos="h", fig.cap="Table One", out.extra=''}
# List how many people didn't come back for visit 2

library(tableone)
library(dplyr)
library(tidyr)
library(kableExtra)
library(gtsummary)

dfHIVAll <- read.csv("./DataRaw/hiv_6624_final.csv") %>% 
  filter(years == 0 | years == 2)

dfHIVAll <- dfHIVAll %>% select(newid, AGG_MENT, AGG_PHYS, BMI, SMOKE, LEU3N, VLOAD, RACE, EDUCBAS, age, ADH, years, hard_drugs)
dfHIVWideAll <- dfHIVAll %>% pivot_wider(names_from = years, values_from = c(AGG_MENT, AGG_PHYS, BMI, SMOKE, LEU3N, VLOAD, RACE, EDUCBAS, age, ADH, hard_drugs)) %>% select(-c(BMI_2, SMOKE_2, RACE_2, EDUCBAS_2, age_2, ADH_0, hard_drugs_2))
dfHIVWideAll <- dfHIVWideAll %>% mutate(BMI_0 = ifelse(BMI_0 > 0 & BMI_0 < 100, BMI_0, NA),
                                        MissingYear2 = is.na(ADH_2))

# create Table 1
dfTableOneMissings <- dfHIVWideAll %>% dplyr::select("AGG_MENT_0", "AGG_MENT_2", "AGG_PHYS_0", "AGG_PHYS_2", "BMI_0", "SMOKE_0", "LEU3N_0", "LEU3N_2", "VLOAD_0", "VLOAD_2", "RACE_0", "EDUCBAS_0", "age_0", "ADH_2", "hard_drugs_0", "MissingYear2") %>%
  mutate(EDUCBAS_0 = case_match(EDUCBAS_0, c(1, 2) ~ "Less than a high school diploma",
                                c(3, 4) ~ "High school diploma or some college",
                                c(5, 6) ~ "College degree or some grad school",
                                7 ~ "Graduate degree"),
         RACE_0 = case_match(RACE_0, 1 ~ "White, non-Hispanic",
                             2 ~ "White, Hispanic",
                             3 ~ "Black, non-Hispanic",
                             c(4,7) ~ "Other",
                             8 ~ "Other Hispanic"),
         SMOKE_0 = case_match(SMOKE_0, 1 ~ "Nonsmoker",
                              2 ~ "Former smoker",
                              3 ~ "Current smoker"),
         ADH_2 = case_match(ADH_2, 1 ~ "100% Adherence",
                            2 ~ "95-99% Adherence",
                            3 ~ "75-94% Adherence",
                            4 ~ "<75% Adherence"),
         hard_drugs_0 = if_else(hard_drugs_0 == 0, "No hard drugs", "Hard drugs"),
         MissingYear2 = ifelse(MissingYear2, "Missing Year 2", "Not Missing Year 2"),
         logVLOAD_0 = log(VLOAD_0),
         logVLOAD_2 = log(VLOAD_2)) %>% 
  rename("Baseline Mental Score" = AGG_MENT_0,
         "Year 2 Mental Score" = AGG_MENT_2,
         "Baseline Physical Score" = AGG_PHYS_0,
         "Year 2 Physical Score" = AGG_PHYS_2,
         "Baseline Log Viral Load" = logVLOAD_0,
         "Year 2 Log Viral Load" = logVLOAD_2,
         "Baseline CD4+ T Count" = LEU3N_0,
         "Year 2 CD4+ T Count" = LEU3N_2,
         "Baseline BMI" = BMI_0,
         "Baseline Education" = EDUCBAS_0,
         "Smoking Status at Baseline" = SMOKE_0,
         "Age at Baseline" = age_0,
         "Adherence to Treatment" = ADH_2,
         "Hard Drugs" = hard_drugs_0,
         "Race" = RACE_0,
         "Missing Year 2" = MissingYear2) %>% select(-c(VLOAD_0, VLOAD_2))

tbl_strata(
  dfTableOneMissings %>% select(-"Adherence to Treatment"),
  strata="Missing Year 2",
  ~ .x %>% tbl_summary(by="Hard Drugs")) %>%
    as_kable_extra(booktabs = TRUE) %>%
  # reduce font size to make table fit. 
  # you may also use the `latex_options = "scale_down"` argument here.
  kableExtra::kable_styling(font_size = 7)
```

The initial summary statistics indicate that subjects who did not have year 2 data had lower initial mental and physical scores, higher viral loads, and lower CD4 T cell counts. Hard drug users were also more likely to drop out than non hard drug users. This may indicate a concern with bias due to drop out. In the complete case data, hard drug users have lower physical and mental scores, higher viral loads, and fewer CD4+ T cell counts. However, this was true both before and after treatment for all outcomes except viral load. 

```{r, echo=FALSE, message=FALSE}
# List how many people didn't come back for visit 2
# 
# library(tableone)
# library(dplyr)
# library(tidyr)
# library(kableExtra)
# 
# dfHIV <- read.csv("./DataRaw/hiv_6624_final.csv") %>% 
#   filter(years == 0 | years == 2)
# 
# dfCounts <- dfHIV %>% group_by(newid) %>% count() %>% filter(n == 2)
# dfHIV <- dfHIV %>% filter(newid %in% dfCounts$newid)
# dfHIV <- dfHIV %>% select(newid, AGG_MENT, AGG_PHYS, BMI, SMOKE, LEU3N, VLOAD, RACE, EDUCBAS, age, ADH, years, hard_drugs)
# dfHIVWide <- dfHIV %>% pivot_wider(names_from = years, values_from = c(AGG_MENT, AGG_PHYS, BMI, SMOKE, LEU3N, VLOAD, RACE, EDUCBAS, age, ADH, hard_drugs)) %>% select(-c(BMI_2, SMOKE_2, RACE_2, EDUCBAS_2, age_2, ADH_0, hard_drugs_2))
# dfHIVFiltered <- dfHIVWide %>% filter(!(is.na(BMI_0) | is.na(SMOKE_0) | is.na(RACE_0) | is.na(EDUCBAS_0) | is.na(age_0) | is.na(ADH_2) | is.na(hard_drugs_0)))
# dfHIVFiltered <- dfHIVFiltered %>% filter(BMI_0 > 0 & BMI_0 < 100)
# 
# # create Table 1
# dfTableOne <- dfHIVFiltered %>% dplyr::select("AGG_MENT_0", "AGG_MENT_2", "AGG_PHYS_0", "AGG_PHYS_2", "BMI_0", "SMOKE_0", "LEU3N_0", "LEU3N_2", "VLOAD_0", "VLOAD_2", "RACE_0", "EDUCBAS_0", "age_0", "ADH_2", "hard_drugs_0") %>%
#   mutate(EDUCBAS_0 = case_match(EDUCBAS_0, c(1, 2) ~ "Less than a high school diploma",
#                                 c(3, 4) ~ "High school diploma or some college",
#                                 c(5, 6) ~ "College degree or some grad school",
#                                 7 ~ "Graduate degree"),
#          RACE_0 = case_match(RACE_0, 1 ~ "White, non-Hispanic",
#                              2 ~ "White, Hispanic",
#                              3 ~ "Black, non-Hispanic",
#                              c(4,7) ~ "Other",
#                              8 ~ "Other Hispanic"),
#          SMOKE_0 = case_match(SMOKE_0, 1 ~ "Nonsmoker",
#                               2 ~ "Former smoker",
#                               3 ~ "Current smoker"),
#          ADH_2 = case_match(ADH_2, 1 ~ "100% Adherence",
#                             2 ~ "95-99% Adherence",
#                             3 ~ "75-94% Adherence",
#                             4 ~ "<75% Adherence"),
#          hard_drugs_0 = if_else(hard_drugs_0 == 0, "No hard drugs", "Hard drugs"),
#          logVLOAD_0 = log(VLOAD_0),
#          logVLOAD_2 = log(VLOAD_2)) %>% 
#   rename("Baseline Mental Score" = AGG_MENT_0,
#          "Year 2 Mental Score" = AGG_MENT_2,
#          "Baseline Physical Score" = AGG_PHYS_0,
#          "Year 2 Physical Score" = AGG_PHYS_2,
#          "Baseline Log Viral Load" = logVLOAD_0,
#          "Year 2 Log Viral Load" = logVLOAD_2,
#          "Baseline CD4+ T Count" = LEU3N_0,
#          "Year 2 CD4+ T Count" = LEU3N_2,
#          "Baseline BMI" = BMI_0,
#          "Baseline Education" = EDUCBAS_0,
#          "Smoking Status at Baseline" = SMOKE_0,
#          "Age at Baseline" = age_0,
#          "Adherence to Treatment" = ADH_2,
#          "Hard Drugs" = hard_drugs_0)
# 
# variables <- c("Baseline Mental Score",
#          "Year 2 Mental Score",
#          "Baseline Physical Score",
#          "Year 2 Physical Score",
#          "Baseline Log Viral Load",
#          "Year 2 Log Viral Load",
#          "Baseline CD4+ T Count",
#          "Year 2 CD4+ T Count",
#          "Baseline BMI",
#          "Age at Baseline", 
#          "Baseline Education", 
#          "Smoking Status at Baseline", 
#          "Adherence to Treatment")
# cat_vars <- c("Baseline Education", "Smoking Status at Baseline", "Adherence to Treatment")
# strata <- "Hard Drugs"
# 
# 
# tab1 <- CreateTableOne(vars = variables,
#                        factorVars = cat_vars,
#                        strata = strata,
#                        test = FALSE,
#                        data=dfTableOne,
#                        addOverall=TRUE)
# 
# tab1_forkbl <- print(tab1, varLabels=T, printToggle = F)
# kbl( tab1_forkbl,
#      caption = 'Descriptive Summary of Sample',
#      booktabs=T, align='ccc')  %>%
#   kable_styling(latex_options = "HOLD_position")
```